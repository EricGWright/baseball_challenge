<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <title>Beer League Baseball Challenge</title>

  <!-- css files -->
  <link href="css/bootstrap.min.css" type="text/css" rel="stylesheet" />
  <link href="css/bootstrap-responsive.min.css" type="text/css" rel="stylesheet" />
  <link href="css/styles.css" type="text/css" rel="stylesheet" />

  <!-- js files -->
  <script src="js/jquery-1.9.1.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/schedule.js"></script>

  <script type="text/javascript">
  $(document).ready(function() {

// ******************* declare variables ************************

    // define min and max number of teams
    var minTeams = 4;
    var maxTeams = 8;

    // create empty global arrays
    var league, schedule, scores = new Array();

// ***************** get game and league data *******************
// Game data is retrieved before league data so that scores will
// be available to the updateSchedule function.

    // retrieve game data from server
    $.ajax({
      url: "/backliftapp/game",
      type: "GET",
      dataType: "JSON",
      success: function (data) {

        // fill scores array with data
        scores = data;

        // confirm contents of scores array
        console.log(scores);

        // retrieve league data from server
        $.ajax({
          url: "/backliftapp/team",
          type: "GET",
          dataType: "JSON",
          success: function (data) {

            // fill league array with data
            league = data;

            // populate standings table
            updateStandings();

            // make delete buttons functional
            deleteTeam();

            // populate schedule table
            updateSchedule();

            // enable start season
            startSeason();

          }
        }); // end GET

      }
    }); // end GET

// ********************* create new team ***********************

    // click event on team form submit button
    $("#createTeam").click(function() {

      // show alert message if too many teams
      if (league.length == maxTeams) {
        $("#formAlert").show();
        $("#teamForm input").val("");
        return;
      };

      // hide alert when dismissed
      $("#alertClose").click(function() {
        $("#formAlert").hide();
      });

      // send team data to server
      $.ajax({
        url: "/backliftapp/team",
        type: "POST",
        dataType: "JSON",
        data: {
        teamName: $("#teamName").val(),
        firstName: $("#firstName").val(),
        lastName: $("#lastName").val(),
        phone: $("#phone").val(),
        sponsor: $("#sponsor").val(),
        zip: $("#zip").val(),
        wins: 0,
        losses: 0,
        percentage: 0
        },
        success: function (data) {

          // update league array
          league.push(data);

          // clear the standings table
          $("#standings tbody").html("");

          // update standings table
          updateStandings();

          // make delete buttons functional
          deleteTeam();

          // update schedule table
          updateSchedule();

          // enable start season
          startSeason();

        }
      }); // end POST

      // clear team form inputs
      $("#teamForm input").val("");

    }); // end click

// ********************** clear scores ***********************

    $("#clearScores").click(function() {

      for (var i = 0; i < scores.length; i ++) {

        // delete game data from server
        $.ajax({
          url: "/backliftapp/game/" + scores[i].id,
          type: "DELETE",
          dataType: "JSON",
          success: function () {

            console.log("Scores cleared.");

          }
        }); // end DELETE

      }; // end for loop

    }); // end click

// ******************** update standings ************************

    // populate standings table
    function updateStandings() {
      for (var i = 0; i < league.length; i++) {
        $("#standings tbody").append("<tr><th class='rank'>" + (i + 1) + ".</th><td class='name'>" + league[i].teamName + "</td><td class='record center'>" + league[i].wins + "</td><td class='record center'>" + league[i].losses + "</td><td class='record center'>" + league[i].percentage + "</td><td><button id='" + i + "' class='btn btn-danger btn-mini delete' type='button'>Delete</button></td></tr>");
      };
    };

// ************************ delete team **************************

    function deleteTeam() {

      // click event on delete buttons
      $(".delete").click(function() {

        // delete team data from server
        $.ajax({
          url: "/backliftapp/team/" + league[$(this).attr("id")].id,
          type: "DELETE",
          dataType: "JSON",
          success: function () {

            // retrieve league data from server
            $.ajax({
              url: '/backliftapp/team',
              type: "GET",
              dataType: "JSON",
              success: function (data) {

                // update league array
                league = data;

                // clear the standings table
                $("#standings tbody").html("");

                // update standings table
                updateStandings();

                // make delete buttons functional
                deleteTeam();

                // update schedule table
                updateSchedule();

                // enable start season
                startSeason();

              }
            }); // end GET

          }
        }); // end DELETE

      }); // end click

    }; // end deleteTeam

// ******************** update schedule *************************

    function updateSchedule() {

      // determine schedule length
      if (league.length < minTeams) {
          $("#schedule ul").html("<li class='active'><a href='#week1' data-toggle='tab'>Week 1</a></li>");
          $("#schedule .tab-content").html("<div id='week1' class='tab-pane active'><table class='table table-striped'><thead><tr><th>Teams</th><th class='center'>Final Score</th></tr></thead><tbody></tbody></table></div>");
      } else if (league.length == 4 || league.length == 5) {
        schedule = sched4;
      } else if (league.length == 6 || league.length == 7) {
        schedule = sched6;
      } else if (league.length == 8) {
        schedule = sched8;
      };

      // verify league has enough teams
      if (league.length >= minTeams) {

        // clear the schedule table
        $("#schedule ul").html("");
        $("#schedule .tab-content").html("");

        // create tabs and panes
        for (var i = 0; i < schedule.length; i++) {
          $("#schedule ul").append("<li><a href='#week" + (i + 1) + "' " + "data-toggle='tab'>Week " + (i + 1) + "</a></li>");
          $("#schedule .tab-content").append("<div id='week" + (i + 1) + "' " + "class='tab-pane'><table class='table table-striped'><thead><tr><th>Teams</th><th class='center'>Final Score</th></tr></thead><tbody></tbody></table></div>");

          // populate schedule with game data
          for (var j = 0; j < schedule[i].length; j++) {
            
            // fill variables with initial values
            var home = league[schedule[i][j][0] - 1].teamName;
            var away = league[schedule[i][j][1] - 1].teamName;
            var homeFinal = 0;
            var awayFinal = 0;

            // find correct scores in scores array
            for (var k = 0; k < scores.length; k++) {
              if (scores[k].homeName == home && scores[k].awayName == away) {
                homeFinal = scores[k].homeScore;
                awayFinal = scores[k].awayScore;
              }
            };

            // write game data to appropriate panes
            $("#week" + (i + 1) + " tbody").append("<tr><td>" + home + " vs. " + away + "</td><td class='center'>" + homeFinal + " - " + awayFinal + "</td><td><a week='" + i + "' game='" + j + "' class='score' href='#scoreModal' data-toggle='modal'>Report Score</a></td></tr>");

          };

        }; // end for loop

        // make report score links functional
        reportScore();

        // make week 1 tab active
        $("#schedule li:first-child").addClass("active");
        $("#week1").addClass("active");  

      }; // end if statment

    }; // end updateSchedule

// ********************** report score ************************

// $('#schedule').on('click', '.score', function(){
//   $(this).
//   reportScore(hometeam, awayteam, hscore, ascore);
// });

    function reportScore() {

      // click event on report score links
      $(".score").click(function() {

        // fill variables with schedule array indices
        var week = $(this).attr("week");
        var game = $(this).attr("game");

        // fill variables with team names
        var homeTeam = league[schedule[week][game][0] - 1].teamName;
        var awayTeam = league[schedule[week][game][1] - 1].teamName;

        // click event on score form submit button
        $("#reportScore").one('click', function() {

          // send game data to server
          $.ajax({
            url: "/backliftapp/game",
            type: "POST",
            dataType: "JSON",
            data: {
            homeName: homeTeam,
            awayName: awayTeam,
            homeScore: $("#homeScore").val(),
            awayScore: $("#awayScore").val()
            },
            success: function (data) {

            // retrieve game data from server
            $.ajax({
              url: "/backliftapp/game",
              type: "GET",
              dataType: "JSON",
              success: function (data) {

                // update scores array
                scores = data;

                // update schedule table
                updateSchedule();

              }
            }); // end GET

            }
          }); // end POST

        }); // end click

      }); // end click

    }; // end reportScore

// ********************** start season ************************

    function startSeason() {

      // show start season button if enough teams
      if (league.length >= minTeams) {
        $("#startSeason").show();
      }

      // hide delete and start season buttons
      $("#startSeason button").click(function() {
        $(".delete").hide();
        $(this).hide();
      });

    };

// ********************* form validation **********************

    // enter form validation here



  }); // end ready
  </script>
</head>
<body>

  <!-- navbar -->
  <div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <ul class="nav">
          <li><a href="#teamModal" data-toggle="modal">Create Team</a></li>
          <li><a id="clearScores" href="#" >Clear Scores</a></li>
        </ul>
        <a id="title" class="brand pull-right" href="#">Beer League Baseball Challenge</a>
      </div>
    </div>
  </div>

  <div id="mainContent" class="container">

    <!-- alert message -->
    <div class="row-fluid">
      <div id="formAlert" class="alert alert-error span12">
        <button id="alertClose" class="close" type="button">&times;</button>
        Sorry, this league already has 8 teams!
      </div>
    </div>

    <div class="row-fluid">

      <!-- standings -->
      <div id="standings" class="span6">
        <h3>Standings</h3>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Team</th>
              <th class="record center">Wins</th>
              <th class="record center">Losses</th>
              <th class="record center">Perc.</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>

      <!-- schedule/results -->
      <div id="schedule" class="span6">
        <h3>Schedule</h3>
        <div class="tabbable tabs-left">
          <!-- default tab -->
          <ul class="nav nav-tabs">
            <li class="active"><a href="#week1" data-toggle="tab">Week 1</a></li>
          </ul>
          <div class="tab-content">
            <!-- default pane -->
            <div id="week1" class="tab-pane active">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Teams</th>
                    <th class="center">Final Score</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div><!-- end .tab-content -->
        </div><!-- end .tabbable -->
      </div><!-- end .span6 -->

    </div><!-- end .row-fluid -->

    <!-- start season button -->
    <div class="row-fluid">
      <div id="startSeason" class="span12">
        <button class="btn btn-primary btn-large" type="button">Start Season!</button>
      </div>
    </div>

    <!-- team form modal -->
    <div id="teamModal" class="modal hide fade">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Team Information</h3>
      </div>
      <div class="modal-body">
        <form id="teamForm" class="form-horizontal">
          <div class="control-group">
            <label class="control-label" for="teamName">Team Name</label>
            <div class="controls">
              <input id="teamName" type="text" name="teamName" placeholder="Ex. Milwaukee Beers" />
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="firstName">Manager's First Name</label>
            <div class="controls">
              <input id="firstName" type="text" name="firstName" placeholder="Ex. Joe" />
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="lastName">Manager's Last Name</label>
            <div class="controls">
              <input id="lastName" type="text" name="lastName" placeholder="Ex. Cooper" />
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="phone">Phone Number</label>
            <div class="controls">
              <input id="phone" type="text" name="phone" placeholder="Ex. 555-555-BEER" />
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="sponsor">Team Sponsor</label>
            <div class="controls">
              <input id="sponsor" type="text" name="sponsor" placeholder="Ex. Milwaukee's Best" />
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="zip">Zip Code</label>
            <div class="controls">
              <input id="zip" type="text" name="zip" placeholder="Ex. 53201" />
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button id="createTeam" class="btn btn-primary" type="submit" data-dismiss="modal" aria-hidden="true">Submit</button>
      </div>
    </div><!-- end #teamModal -->

    <!-- score form modal -->
    <div id="scoreModal" class="modal hide fade">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Report Score</h3>
      </div>
      <div class="modal-body">
        <form id="scoreForm">
          <h4 id="marquee"></h4>
          <input id="homeScore" type="text" name="homeScore" />
          <input id="awayScore" type="text" name="awayScore" />
        </form>
      </div>
      <div class="modal-footer">
        <button id="reportScore" class="btn btn-primary" type="submit" data-dismiss="modal" aria-hidden="true">Submit</button>
      </div>
    </div><!-- end #scoreModal -->

  </div><!-- end .container -->
</body>
</html>