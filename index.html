<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <title>Beer League Baseball Challenge</title>

  <!-- css files -->
  <link href="css/bootstrap.min.css" type="text/css" rel="stylesheet" />
  <link href="css/bootstrap-responsive.min.css" type="text/css" rel="stylesheet" />
  <link href="css/styles.css" type="text/css" rel="stylesheet" />

  <!-- js files -->
  <script src="js/jquery-1.9.1.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/schedule.js"></script>

  <script type="text/javascript">
  $(document).ready(function() {

// ***************** declare global variables *******************

    // define min and max number of teams
    var minTeams = 4;
    var maxTeams = 8;

    // create empty arrays
    var league, schedule, scores = new Array();

// ****************** max team alert message ********************

    // show alert message if too many teams
    $("a[href='#teamModal']").click(function() {
      if (league.length == maxTeams) {
        $("#formAlert").show();
        return false;
      };
    });

    // hide alert when dismissed
    $("#alertClose").click(function() {
      $("#formAlert").hide();
    });

// ***************** get game and league data *******************
// Game data is retrieved before league data so that scores will
// be available to the updateSchedule function.

    // retrieve game data from server
    $.ajax({
      url: "/backliftapp/game",
      type: "GET",
      dataType: "JSON",
      success: function (data) {

        // fill scores array with data
        scores = data;

        // confirm contents of scores array
        console.log(scores);

        // retrieve league data from server
        $.ajax({
          url: "/backliftapp/team",
          type: "GET",
          dataType: "JSON",
          success: function (data) {

            // fill league array with data
            league = data;

            // confirm contents of league array
            console.log(league);

            // populate standings table
            updateStandings();

            // click event on delete buttons
            $("#standings").on("click", ".delete", function() {
              var teamID = $(this).attr("id");
              deleteTeam(teamID);
            });

            // populate schedule table
            updateSchedule();

            // check if season can start
            startSeason();

          }
        }); // end GET

      }
    }); // end GET

// ************ make report score links functional *************

    // create empty variables
    var homeTeam, awayTeam, week, game;

    // click event on report score links
    $(".tab-content").on("click", ".score", function() {

      // fill variables with schedule index values
      week = $(this).attr("data-week");
      game = $(this).attr("data-game");

      // fill variables with team objects
      if (league.length % 2 == 0) { // even number of teams
        homeTeam = league[schedule[week][game][0] - 1];
        awayTeam = league[schedule[week][game][1] - 1];
      } else { // odd number of teams
        homeTeam = league[schedule[week][game][0] - 2];
        awayTeam = league[schedule[week][game][1] - 2];
      };

      // write team names to score form
      $("#marquee").html("<span id='homeTeam'>" + homeTeam.teamName + "</span>vs.<span id='awayTeam'>" + awayTeam.teamName + "</span>");

    }); // end click


// ********** make score form submit button functional **********

    // click event on score form submit button
    $("#reportScore").click(function() {

      // fill variables with scores
      var homeScore = $("#homeScore").val();
      var awayScore = $("#awayScore").val();

      // send game data to server
      reportScore(homeTeam, awayTeam, homeScore, awayScore, week);

    }); // end click

// ********************* create new team ***********************

    // click event on team form submit button
    $("#createTeam").click(function() {

      // send team data to server
      $.ajax({
        url: "/backliftapp/team",
        type: "POST",
        dataType: "JSON",
        data: {
        teamName: $("#teamName").val(),
        firstName: $("#firstName").val(),
        lastName: $("#lastName").val(),
        phone: $("#phone").val(),
        sponsor: $("#sponsor").val(),
        zip: $("#zip").val(),
        wins: 0,
        losses: 0,
        percentage: 0
        },
        success: function (data) {

          // update league array
          league.push(data);

          // update standings table
          updateStandings();

          // click event on delete buttons
          $("#standings").on("click", ".delete", function() {
            var teamID = $(this).attr("id");
            deleteTeam(teamID);
          });

          // update schedule table
          updateSchedule();

          // check if season can start
          startSeason();

        }
      }); // end POST

      // clear team form inputs
      $("#teamForm input").val("");

    }); // end click

// ********************** clear scores ***********************

    $("#clearScores").click(function() {

      for (var i = 0; i < scores.length; i ++) {

        // delete all game data from server
        $.ajax({
          url: "/backliftapp/game/" + scores[i].id,
          type: "DELETE",
          dataType: "JSON",
          success: function () {

            console.log("Scores cleared.");

          }
        }); // end DELETE

      }; // end for loop

    }); // end click

// *********************** start season ************************

    // hide delete and start season buttons
    $("#startSeason button").click(function() {
      $(".delete").hide();
      $(this).hide();
    });

// ******************** update standings ************************

    function updateStandings() {

      // clear standings table
      $("#standings tbody").html("");

      // populate standings table
      for (var i = 0; i < league.length; i++) {

        // fill variables with popover content
        var popoverTitle = "<h4 class=\"infoTitle\">" + league[i].teamName + "</h4>";
        var popoverContent = "<b>Manager:</b> " + league[i].firstName + " " + league[i].lastName + "<br /><b>Phone Number:</b> " + league[i].phone + "<br /><b>Team Sponsor:</b> " + league[i].sponsor + "<br /><b>Zip Code:</b> " + league[i].zip;

        // write data to standings table
        $("#standings tbody").append("<tr><th class='rank'>" + (i + 1) + ".</th><td class='name'><a class='teamInfo' href='#' title='" + popoverTitle + "' data-content='" + popoverContent + "'>" + league[i].teamName + "</a></td><td class='record'>" + league[i].wins + "</td><td class='record'>" + league[i].losses + "</td><td class='record'>" + league[i].percentage + "</td><td class='deleteColumn'><button id='" + league[i].id + "' class='btn btn-danger btn-mini delete' type='button'>Delete</button></td></tr>");

      }; // end for loop

    }; // end updateStandings

// ************************ delete team **************************

    function deleteTeam(teamID) {

      // delete team data from server
      $.ajax({
        url: "/backliftapp/team/" + teamID,
        type: "DELETE",
        dataType: "JSON",
        success: function () {

          // retrieve league data from server
          $.ajax({
            url: '/backliftapp/team',
            type: "GET",
            dataType: "JSON",
            success: function (data) {

              // update league array
              league = data;

              // update standings table
              updateStandings();

              // click event on delete buttons
              $("#standings").on("click", ".delete", function() {
                var teamID = $(this).attr("id");
                deleteTeam(teamID);
              });

              // update schedule table
              updateSchedule();

             // check if season can start
              startSeason();

            }
          }); // end GET

        }
      }); // end DELETE

    }; // end deleteTeam

// ******************** update schedule *************************

    function updateSchedule(activePane) {

      // determine schedule length
      if (league.length < minTeams) {
          $("#schedule ul").html("<li class='active'><a href='#pane0' data-toggle='tab'>Week 1</a></li>");
          $("#schedule .tab-content").html("<div id='pane0' class='tab-pane active'><table class='table table-striped'><thead><tr><th class='teams'>Teams</th><th class='final'>Final Score</th><th class='report'></th></tr></thead><tbody></tbody></table></div>");
      } else if (league.length == 4) {
        schedule = sched4;
      } else if (league.length == 5 || league.length == 6) {
        schedule = sched6;
      } else if (league.length == 7 || league.length == 8) {
        schedule = sched8;
      };

      // verify league has enough teams
      if (league.length >= minTeams) {

        // clear schedule table
        $("#schedule ul").html("");
        $("#schedule .tab-content").html("");

        // create tabs and panes
        for (var i = 0; i < schedule.length; i++) {
          $("#schedule ul").append("<li id='tab" + i + "'><a href='#pane" + i + "' " + "data-toggle='tab'>Week " + (i + 1) + "</a></li>");
          $("#schedule .tab-content").append("<div id='pane" + i + "' " + "class='tab-pane'><table class='table table-striped'><thead><tr><th class='teams'>Teams</th><th class='final'>Final Score</th><th class='report'></th></tr></thead><tbody></tbody></table></div>");

          // initialize counter and write bye weeks
          if (league.length % 2 == 0) { // even number of teams
            var j = 0;
          } else { // odd number of teams
            // Team 1 on the schedule becomes a ghost team,
            // and whichever team plays them has a bye week.
            var j = 1;
            $("#pane" + i + " tbody").append("<tr><td class='teams'>" + league[schedule[i][0][1] - 2].teamName + "</td><td class='final'>Bye</td><td class='report'></td></tr>");
          }; // end if statement

          // populate schedule with game data
          while (j < schedule[i].length) {
            
            // fill variables with initial values
            if (league.length % 2 == 0) { // even number of teams
              var home = league[schedule[i][j][0] - 1].teamName;
              var away = league[schedule[i][j][1] - 1].teamName;                
            } else { // odd number of teams
              var home = league[schedule[i][j][0] - 2].teamName;
              var away = league[schedule[i][j][1] - 2].teamName;
            };
            var homeFinal = 0;
            var awayFinal = 0;

            // find correct scores in scores array
            for (var k = 0; k < scores.length; k++) {
              if (scores[k].homeName == home && scores[k].awayName == away) {
                homeFinal = scores[k].homeScore;
                awayFinal = scores[k].awayScore;
              };
            };

            // write game data to panes
            $("#pane" + i + " tbody").append("<tr><td class='teams'>" + home + " vs. " + away + "</td><td class='final'>" + homeFinal + " - " + awayFinal + "</td><td class='report'><a data-week='" + i + "' data-game='" + j + "' class='score' href='#scoreModal' data-toggle='modal'>Report Score</a></td></tr>");

            // increment counter
            j++;

          }; // end while loop

        }; // end for loop

        // set active pane
        if (activePane) { // maintain active pane
          $("#tab" + activePane).addClass("active");
          $("#pane" + activePane).addClass("active");
        } else { // make week 1 pane active
          $("#tab0").addClass("active");
          $("#pane0").addClass("active");
        };

      }; // end if statment

    }; // end updateSchedule

// ********************** report score ************************

    function reportScore(homeTeam, awayTeam, homeScore, awayScore, activePane) {

      // send game data to server
      $.ajax({
        url: "/backliftapp/game",
        type: "POST",
        dataType: "JSON",
        data: {
        homeName: homeTeam.teamName,
        awayName: awayTeam.teamName,
        homeScore: homeScore,
        awayScore: awayScore
        },
        success: function (data) {

        // retrieve game data from server
        $.ajax({
          url: "/backliftapp/game",
          type: "GET",
          dataType: "JSON",
          success: function (data) {

            // update scores array
            scores = data;

            // update schedule table
            updateSchedule(activePane);

          }
        }); // end GET

        }
      }); // end POST

      // update wins and losses
      updateRecord(homeTeam, awayTeam, homeScore, awayScore);

    }; // end reportScore

// ****************** update wins and losses ******************

    function updateRecord(homeTeam, awayTeam, homeScore, awayScore) {


      // determine winner and loser
      if (+homeScore > +awayScore) {

        // increment home team wins
        $.ajax({
          url: "/backliftapp/team/" + homeTeam.id,
          type: "PUT",
          dataType: "JSON",
          data: {
            wins: +homeTeam.wins + 1,
          },
          success: function (data) {

          // increment away team losses
          $.ajax({
            url: "/backliftapp/team/" + awayTeam.id,
            type: "PUT",
            dataType: "JSON",
            data: {
              losses: +awayTeam.losses + 1,
            },
            success: function (data) {

            // retrieve league data from server
            $.ajax({
              url: "/backliftapp/team",
              type: "GET",
              dataType: "JSON",
              success: function (data) {

                // fill league array with data
                league = data;

                // populate standings table
                updateStandings();

                // click event on delete buttons
                $("#standings").on("click", ".delete", function() {
                  var teamID = $(this).attr("id");
                  deleteTeam(teamID);
                });

              }
            }); // end GET

            }
          }); // end PUT

          }
        }); // end PUT

      } else {

        // increment home team losses
        $.ajax({
          url: "/backliftapp/team/" + homeTeam.id,
          type: "PUT",
          dataType: "JSON",
          data: {
            losses: +homeTeam.losses + 1,
          },
          success: function (data) {

          // increment away team wins
          $.ajax({
            url: "/backliftapp/team/" + awayTeam.id,
            type: "PUT",
            dataType: "JSON",
            data: {
              wins: +awayTeam.wins + 1,
            },
            success: function (data) {

            // retrieve league data from server
            $.ajax({
              url: "/backliftapp/team",
              type: "GET",
              dataType: "JSON",
              success: function (data) {

                // fill league array with data
                league = data;

                // populate standings table
                updateStandings();

                // click event on delete buttons
                $("#standings").on("click", ".delete", function() {
                  var teamID = $(this).attr("id");
                  deleteTeam(teamID);
                });

              }
            }); // end GET

            }
          }); // end PUT

          }
        }); // end PUT

      }; // end if statement

      // clear score form inputs
      $("#scoreForm input").val("");

    }; // end updateRecord

// **************** check if season can start *****************

    // show start season button if enough teams
    function startSeason() {
      if (league.length >= minTeams) {
        $("#startSeason").show();
      }
    };

// ******************** initialize popover ********************

    $("#standings").popover({
      selector: ".teamInfo",
      html: true,
      placement: "right",
      trigger: "hover",
    });

// ********************* form validation **********************

    // enter form validation here



  }); // end ready
  </script>
</head>
<body>

  <!-- navbar -->
  <div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
      <div class="container">
        <ul class="nav">
          <li><a href="#teamModal" data-toggle="modal">Create Team</a></li>
          <li><a id="clearScores" href="#" >Clear Scores</a></li>
        </ul>
        <a id="title" class="brand pull-right" href="#">Beer League Baseball Challenge</a>
      </div>
    </div>
  </div>

  <div id="mainContent" class="container">

    <!-- alert message -->
    <div class="row-fluid">
      <div id="formAlert" class="alert alert-error span12">
        <button id="alertClose" class="close" type="button">&times;</button>
        Sorry, this league already has 8 teams!
      </div>
    </div>

    <div class="row-fluid">

      <!-- standings -->
      <div id="standings" class="span6">
        <h3>Standings</h3>
        <table class="table table-striped">
          <thead>
            <tr>
              <th class="rank">Rank</th>
              <th class="name">Team</th>
              <th class="record">Wins</th>
              <th class="record">Losses</th>
              <th class="record">Perc.</th>
              <th class="deleteColumn"></th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>

      <!-- schedule/results -->
      <div id="schedule" class="span6">
        <h3>Schedule</h3>
        <div class="tabbable tabs-left">
          <!-- default tab -->
          <ul class="nav nav-tabs">
            <li id="tab0" class="active"><a href="#pane0" data-toggle="tab">Week 1</a></li>
          </ul>
          <div class="tab-content">
            <!-- default pane -->
            <div id="pane0" class="tab-pane active">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th class="teams">Teams</th>
                    <th class="final">Final Score</th>
                    <th class="report"></th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div><!-- end .tab-content -->
        </div><!-- end .tabbable -->
      </div><!-- end .span6 -->

    </div><!-- end .row-fluid -->

    <!-- start season button -->
    <div class="row-fluid">
      <div id="startSeason" class="span12">
        <button class="btn btn-primary btn-large" type="button">Start Season!</button>
      </div>
    </div>

    <!-- team form modal -->
    <div id="teamModal" class="modal hide fade">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Team Information</h3>
      </div>
      <div class="modal-body">
        <form id="teamForm" class="form-horizontal">
          <div class="control-group">
            <label class="control-label" for="teamName">Team Name</label>
            <div class="controls">
              <input id="teamName" type="text" name="teamName" placeholder="Ex. Milwaukee Beers" />
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="firstName">Manager's First Name</label>
            <div class="controls">
              <input id="firstName" type="text" name="firstName" placeholder="Ex. Joe" />
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="lastName">Manager's Last Name</label>
            <div class="controls">
              <input id="lastName" type="text" name="lastName" placeholder="Ex. Cooper" />
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="phone">Phone Number</label>
            <div class="controls">
              <input id="phone" type="text" name="phone" placeholder="Ex. 555-555-BEER" />
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="sponsor">Team Sponsor</label>
            <div class="controls">
              <input id="sponsor" type="text" name="sponsor" placeholder="Ex. Milwaukee's Best" />
            </div>
          </div>
          <div class="control-group">
            <label class="control-label" for="zip">Zip Code</label>
            <div class="controls">
              <input id="zip" type="text" name="zip" placeholder="Ex. 53201" />
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button id="createTeam" class="btn btn-primary" type="submit" data-dismiss="modal" aria-hidden="true">Submit</button>
      </div>
    </div><!-- end #teamModal -->

    <!-- score form modal -->
    <div id="scoreModal" class="modal hide fade">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h3>Report Score</h3>
      </div>
      <div class="modal-body">
        <form id="scoreForm">
          <h4 id="marquee"></h4>
          <input id="homeScore" type="text" name="homeScore" />&mdash;<input id="awayScore" type="text" name="awayScore" />
        </form>
      </div>
      <div class="modal-footer">
        <button id="reportScore" class="btn btn-primary" type="submit" data-dismiss="modal" aria-hidden="true">Submit</button>
      </div>
    </div><!-- end #scoreModal -->

  </div><!-- end .container -->
</body>
</html>